<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-CMake-简单用法" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/11/24/CMake-%E7%AE%80%E5%8D%95%E7%94%A8%E6%B3%95/" class="article-date">
  <time class="dt-published" datetime="2023-11-24T02:47:38.000Z" itemprop="datePublished">2023-11-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/11/24/CMake-%E7%AE%80%E5%8D%95%E7%94%A8%E6%B3%95/">CMake 简单用法</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <img title="" src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/cmake/2023-11-24-11-28-33-image.png" alt="" width="305" data-align="center">

<h4 id="编译："><a href="#编译：" class="headerlink" title="编译："></a>编译：</h4><p>编译时，编译器需要的是语法的正确，函数与变量的声明的正确。对于后者，通常是你需要告诉编译器头文件的所在位置（头文件中应该只是声明，而定义应该放在C&#x2F;C++文件中），只要所有的语法正确，编译器就可以编译出中间目标文件。一般来说，每个源文件都应该对应于一个中间目标文件（ <code>.o</code> 文件或 <code>.obj</code> 文件）。</p>
<h4 id="链接："><a href="#链接：" class="headerlink" title="链接："></a>链接：</h4><p>链接时，主要是链接函数和全局变量。所以，我们可以使用这些中间目标文件（ <code>.o</code> 文件或 <code>.obj</code> 文件）来链接我们的应用程序。链接器并不管函数所在的源文件，只管函数的中间目标文件（Object File），在大多数时候，由于源文件太多，编译生成的中间目标文件太多，而在链接时需要明显地指出中间目标文件名，这对于编译很不方便。所以，我们要给中间目标文件打个包，在Windows下这种包叫“库文件”（Library File），也就是 <code>.lib</code> 文件，在UNIX下，是Archive File，也就是 <code>.a</code> 文件。</p>
<h3 id="CMake-定位"><a href="#CMake-定位" class="headerlink" title="CMake 定位"></a>CMake 定位</h3><table>
<thead>
<tr>
<th>其他Make 工具</th>
<th>CMake</th>
</tr>
</thead>
<tbody><tr>
<td>GNU Make ，QT 的 qmake ，微软的 MS nmake，BSD Make（pmake），Makepp</td>
<td>CMake</td>
</tr>
<tr>
<td>对应着不同的Makefile</td>
<td>采用平台统一的CMakeLists.txt 生成自适应的Makefile</td>
</tr>
<tr>
<td>make Makefile 编译 ：不同产商的make各不相同，也有不同的语法，但其本质都是在 “文件依赖性”上做文章</td>
<td>make Makefile 编译</td>
</tr>
</tbody></table>
<h3 id="CMake用法"><a href="#CMake用法" class="headerlink" title="CMake用法"></a>CMake用法</h3><p><img src="/Users/PeppaZhu/Library/Application%20Support/marktext/images/2023-11-24-11-30-50-image.png"></p>
<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><p>工程编译规则，描述了整个工程的编译和链接等规则。其中包含了哪些文件需要编译，哪些文件不需要编译，哪些需要先编译，哪些需要重建等。</p>
<p>在生成makefile这步时 会进行语法检查么 会进行.cpp 到.o 么 ？不会。makefile只是编译规则 还没开始编译。makefile命令中就包含了调用gcc（也可以是别的编译器）去编译某个源文件的命令。</p>
<h3 id="Make"><a href="#Make" class="headerlink" title="Make"></a>Make</h3><p>make工具就根据makefile中的命令进行编译和链接的。生成.o 这类文件，再进一步链接生成.exe这类文件。</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a target="_blank" rel="noopener" href="https://www.zhaixue.cc/makefile/makefile-intro.html">Makefile 简介 - Makefile基本概念介绍 - Makefile 简明教程 | 宅学部落</a></p>
<p><a target="_blank" rel="noopener" href="https://seisman.github.io/how-to-write-makefile/overview.html">概述 &amp;mdash; 跟我一起写Makefile 1.0 文档</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44498318/article/details/106219135">Linux Makefile：使用CMake生成Makefile文件_cmake写makefile-CSDN博客</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/11/24/CMake-%E7%AE%80%E5%8D%95%E7%94%A8%E6%B3%95/" data-id="clpcciaut0000aefb7gdj1iie" data-title="CMake 简单用法" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CMake/" rel="tag">CMake</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-常见操作的耗时" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/11/22/%E5%B8%B8%E8%A7%81%E6%93%8D%E4%BD%9C%E7%9A%84%E8%80%97%E6%97%B6/" class="article-date">
  <time class="dt-published" datetime="2023-11-22T02:38:36.000Z" itemprop="datePublished">2023-11-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/11/22/%E5%B8%B8%E8%A7%81%E6%93%8D%E4%BD%9C%E7%9A%84%E8%80%97%E6%97%B6/">常见操作的耗时</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="在c-release层面"><a href="#在c-release层面" class="headerlink" title="在c release层面"></a>在c release层面</h3><table>
<thead>
<tr>
<th>分辨率 H*W 1280 720</th>
<th>耗时（MS）</th>
<th>包含基本操作</th>
</tr>
</thead>
<tbody><tr>
<td>3*3 avg filter 普通写法</td>
<td>1.02</td>
<td>读写 <strong>+</strong>: 8  <strong>&#x2F;</strong> :1</td>
</tr>
<tr>
<td>5*5 avg filter 普通写法</td>
<td>2.54</td>
<td>读写 <strong>+</strong> 24 <strong>&#x2F;</strong>:1</td>
</tr>
<tr>
<td>3*3 winsum avg filter</td>
<td>0.93</td>
<td>读写 <strong>+</strong>: 2 <strong>&#x2F;</strong>: 1 other prepare for window</td>
</tr>
<tr>
<td>5*5 winsum avg filter</td>
<td>0.94</td>
<td>读写 <strong>+</strong>: 2 <strong>&#x2F;</strong>: 1 other prepare for window</td>
</tr>
<tr>
<td>2 to 1 down sample</td>
<td>0.23</td>
<td>读写</td>
</tr>
<tr>
<td>1&#x2F;4 H*W upsample (video filter)</td>
<td>1.52</td>
<td>读写 <strong>+</strong>:4  &#x2F; :5</td>
</tr>
<tr>
<td>1&#x2F;16 H*W upsample(video filter)</td>
<td>1.51</td>
<td>读写 <strong>+</strong>:4  &#x2F; :5</td>
</tr>
<tr>
<td>1&#x2F;4 H*W upsample (specialRatio_bilinear up)</td>
<td>0.60</td>
<td>读写 <strong>+</strong>:4  &#x2F; :1</td>
</tr>
<tr>
<td>1&#x2F;16 H*W upsample (specialRatio_bilinear up)</td>
<td>0.44</td>
<td>读写 <strong>+</strong>:4  &#x2F; :1</td>
</tr>
<tr>
<td>3*3 avg filter 1&#x2F;4 HxW 普通写法</td>
<td>0.26</td>
<td></td>
</tr>
<tr>
<td>5*5 avg filter 1&#x2F;4 HxW winsum</td>
<td>0.24</td>
<td></td>
</tr>
</tbody></table>
<h3 id="手写单指令多数据-armv8-加速效果"><a href="#手写单指令多数据-armv8-加速效果" class="headerlink" title="手写单指令多数据 armv8 加速效果"></a>手写单指令多数据 armv8 加速效果</h3><table>
<thead>
<tr>
<th>分辨率 H*W 1280 720</th>
<th>耗时（MS）</th>
<th>包含基本操作</th>
</tr>
</thead>
<tbody><tr>
<td>3*3 avg filter 普通写法</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5*5 avg filter 普通写法</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3*3 winsum avg filter</td>
<td>0.13</td>
<td></td>
</tr>
<tr>
<td>5*5 winsum avg filter</td>
<td>0.14</td>
<td></td>
</tr>
<tr>
<td>2 to 1 down sample</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1&#x2F;4 H*W upsample (video filter)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1&#x2F;16 H*W upsample(video filter)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1&#x2F;4 H*W upsample (specialRatio_bilinear up)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1&#x2F;16 H*W upsample (specialRatio_bilinear up)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3*3 avg filter 256x144 winsum</td>
<td>0.01</td>
<td></td>
</tr>
<tr>
<td>5*5 avg filter  256x144 winsum</td>
<td>0.01</td>
<td></td>
</tr>
</tbody></table>
<h3 id="单指令多数据常用操作-intrinsic"><a href="#单指令多数据常用操作-intrinsic" class="headerlink" title="单指令多数据常用操作 intrinsic"></a>单指令多数据常用操作 intrinsic</h3><p>mla 乘加或者乘减比分开做要快</p>
<p>循环费时 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/11/22/%E5%B8%B8%E8%A7%81%E6%93%8D%E4%BD%9C%E7%9A%84%E8%80%97%E6%97%B6/" data-id="clp9d6hsa00009nfb8w3hfhby" data-title="常见操作的耗时" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B1%87%E7%BC%96/" rel="tag">汇编</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-arm-intrinsic-指令查询技巧" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/11/21/arm-intrinsic-%E6%8C%87%E4%BB%A4%E6%9F%A5%E8%AF%A2%E6%8A%80%E5%B7%A7/" class="article-date">
  <time class="dt-published" datetime="2023-11-21T10:54:13.000Z" itemprop="datePublished">2023-11-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/11/21/arm-intrinsic-%E6%8C%87%E4%BB%A4%E6%9F%A5%E8%AF%A2%E6%8A%80%E5%B7%A7/">arm intrinsic 指令查询技巧</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="查询指令的网址"><a href="#查询指令的网址" class="headerlink" title="查询指令的网址"></a>查询指令的网址</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012385733/article/details/121086734">ARM Neon Intrinsics各函数介绍_arm neon intrinsic 函数_June_Hou的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.arm.com/architectures/instruction-sets/intrinsics/#q=vmovl_high_u16">https://developer.arm.com/architectures/instruction-sets/intrinsics/#q=vmovl_high_u16</a></p>
<h4 id="总的来说"><a href="#总的来说" class="headerlink" title="总的来说"></a>总的来说</h4><p><strong>正常指令</strong>   操作64位 指令后加q了的话128位</p>
<p><strong>长指令</strong>       指令后面加l ，结果比两个操作数要长</p>
<p><strong>宽指令</strong>       指令后面加w 两种数据类型不一样相加减等 生成的数据类型取较宽的那个</p>
<p><strong>窄指令</strong>       指令后面加hn 对应的长指令 加减之后 结果比原本两个一样类型的输入要窄</p>
<p><strong>饱和指令</strong>   指令后面加q 自动限制在数据范围内</p>
<h4 id="基本运算"><a href="#基本运算" class="headerlink" title="基本运算"></a>基本运算</h4><p><strong>乘法</strong> mul</p>
<p><strong>乘加</strong> mla</p>
<p><strong>加法</strong> add</p>
<p><strong>减法</strong> sub</p>
<p><strong>位移</strong> shl shr </p>
<p><strong>取大小</strong> min max</p>
<p><strong>绝对值</strong> vabs </p>
<p><strong>取反</strong> vneg</p>
<p>和查表有关的：tb 但只支持表格很小？unit8x8这种table + index</p>
<h4 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h4><p>vceq （vector compare equal）</p>
<p>vcge a&gt;&#x3D;b? (Greater equal</p>
<p>vcle   a&lt;&#x3D;b? </p>
<p>Vcgt a&gt;b greater than</p>
<p>Vclt a&lt;b</p>
<p>Vcage |a| &gt;&#x3D; |b| (vector compare absolute greater equal</p>
<p>r &#x3D; |a - b| vabd vector absolute difference </p>
<p>R &#x3D; a + |b -c| vaba absolute difference and accumulate</p>
<h4 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h4><p>r &#x3D; a|(~b) vorn_s8   or not</p>
<p>R &#x3D; ~a &amp; b vbic_s8 bitwise clear</p>
<p>R &#x3D; a ^ b veor_s8 exclusive or</p>
<p>R &#x3D; a | b vorr_s8 or</p>
<p>R &#x3D; a &amp; b vand_s8 and</p>
<p>R &#x3D; ~a vmvn_s8</p>
<h4 id="赋值or读写"><a href="#赋值or读写" class="headerlink" title="赋值or读写"></a>赋值or读写</h4><p><strong>vdup_n_s8</strong> duplicate a scalar into every element of vector ??? Dup mov？？？</p>
<p>Dup是把一个数据复制多份的关键词</p>
<p><strong>Ld</strong> 则是正常load 的关键词</p>
<p><strong>Mov</strong>是 拿到一些高位 或者地位 就是操作数和结果位宽不同？（好像也不一定 偶尔和dup等价？</p>
<p><strong>Get</strong>是 把unit8<em>16 拆成uint8</em>8 x2 这种 位宽相同 并行个数不同 vget_high vget_low</p>
<p>cvt convert数据类型</p>
<p><strong>combine</strong> 把8个*2 合并成16个</p>
<p>int8x16_t vcombine_s(int8x8_t a,int8x8_t b)</p>
<p>create 从uint64 create uint8x8</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/11/21/arm-intrinsic-%E6%8C%87%E4%BB%A4%E6%9F%A5%E8%AF%A2%E6%8A%80%E5%B7%A7/" data-id="clp88e15c0002ppfb32b83gdo" data-title="arm intrinsic 指令查询技巧" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B1%87%E7%BC%96/" rel="tag">汇编</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-banding-artifact" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/11/14/banding-artifact/" class="article-date">
  <time class="dt-published" datetime="2023-11-14T07:43:46.000Z" itemprop="datePublished">2023-11-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/11/14/banding-artifact/">banding artifact</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="banding-现象"><a href="#banding-现象" class="headerlink" title="banding 现象"></a>banding 现象</h2><h3 id="单帧"><a href="#单帧" class="headerlink" title="单帧"></a>单帧</h3><p>图像平坦渐变区域，出现条带状变化</p>
<h3 id="多帧"><a href="#多帧" class="headerlink" title="多帧"></a>多帧</h3><p>随着时间推进，条带状变化移动</p>
<h2 id="banding-造成原因和解决办法"><a href="#banding-造成原因和解决办法" class="headerlink" title="banding 造成原因和解决办法"></a>banding 造成原因和解决办法</h2><h3 id="量化"><a href="#量化" class="headerlink" title="量化"></a>量化</h3><p>色彩空间转化时，中间空间的量化： RGB 2 YUV 2 RGB</p>
<p>中间运算中的量化： Y‘ &#x3D; kY + mU + nV</p>
<p><strong>尽量避免中间运算的量化，尤其避免中间运算的<mark>多步量化</mark></strong></p>
<h3 id="拉伸"><a href="#拉伸" class="headerlink" title="拉伸"></a>拉伸</h3><p>拉伸会导致原来+1 的数据+2  Y‘ &#x3D; kY k&gt;1</p>
<p>压缩会导致原来不规则（-1 -2 随机）变化的数据 规则的-1   Y‘ &#x3D; kY k&lt;1</p>
<p>不合理的拉伸公式：UV &#x3D; f(y), 导致在RGB域无法连续变化</p>
<p><strong>避免映射曲线的斜率过大或者过小，注意<mark>多步变化相当于曲线相乘</mark>，进一步增大斜率</strong></p>
<h3 id="过于规则"><a href="#过于规则" class="headerlink" title="过于规则"></a>过于规则</h3><p>平坦区域如果变化过于规则，视觉也能看到banding</p>
<p><strong>加噪音</strong></p>
<h3 id="多帧-1"><a href="#多帧-1" class="headerlink" title="多帧"></a>多帧</h3><p>随着时间的推移，输入在渐变，但是经过上述的异常引入，表现出banding 移动</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/11/14/banding-artifact/" data-id="clp88e15d0003ppfb0ct0g3tb" data-title="banding artifact" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ControlNet" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/11/01/ControlNet/" class="article-date">
  <time class="dt-published" datetime="2023-11-01T07:06:18.000Z" itemprop="datePublished">2023-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/11/01/ControlNet/">ControlNet</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/11/01/ControlNet/" data-id="clp88e1590000ppfb90f70m23" data-title="ControlNet" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AIGC/" rel="tag">AIGC</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-测试阶段" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/10/24/%E6%B5%8B%E8%AF%95%E9%98%B6%E6%AE%B5/" class="article-date">
  <time class="dt-published" datetime="2023-10-24T06:21:51.000Z" itemprop="datePublished">2023-10-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/10/24/%E6%B5%8B%E8%AF%95%E9%98%B6%E6%AE%B5/">测试阶段</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol>
<li><p>C++ 多次运行，测试结果的一致性</p>
</li>
<li><p>开启这些诊断<img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/test_stage/2023-10-24-14-29-00-image.png"></p>
</li>
<li><p>长时间开启，测试内存</p>
</li>
<li><p>汇编和C++测试一致性</p>
</li>
<li><p>视频任务，测试各种分辨率（不同视频不同分辨率，同一个视频中间切换分辨率）</p>
</li>
<li><p>视频任务，测试其中某些帧内存申请失败，会不会导致整个线程挂掉</p>
</li>
<li><p>测试同其他feature 一同运行结果是否正常</p>
</li>
<li><p>测试不同机型下运行时间</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/10/24/%E6%B5%8B%E8%AF%95%E9%98%B6%E6%AE%B5/" data-id="clofdh9ex0003n8fb8mux8szk" data-title="测试阶段" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-DDPM-DDIM-SDE-CompVis" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/10/19/DDPM-DDIM-SDE-CompVis/" class="article-date">
  <time class="dt-published" datetime="2023-10-19T05:47:25.000Z" itemprop="datePublished">2023-10-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/10/19/DDPM-DDIM-SDE-CompVis/">DDPM_DDIM_SDE_CompVis</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="DDPM"><a href="#DDPM" class="headerlink" title="DDPM"></a>DDPM</h3><p><em>Denoising Diffusion Probabilistic Models</em></p>
<p><a target="_blank" rel="noopener" href="https://github.com/betterlmy/ddpm_abarankab">https://github.com/betterlmy/ddpm_abarankab</a></p>
<h4 id="公式原理"><a href="#公式原理" class="headerlink" title="公式原理"></a>公式原理</h4><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-14-04-57-image.png" title="" alt="" data-align="center">

<h6 id="正向一步步加噪音："><a href="#正向一步步加噪音：" class="headerlink" title="正向一步步加噪音："></a>正向一步步加噪音：</h6><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-14-06-18-image.png" title="" alt="" data-align="center">

<p>beta是一个设定好的和t有关的超参数，噪音就是随机高斯噪音</p>
<h6 id="正向一步得到加噪结果"><a href="#正向一步得到加噪结果" class="headerlink" title="正向一步得到加噪结果"></a>正向一步得到加噪结果</h6><p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-14-15-37-image.png"></p>
<h6 id="网络训练去噪器"><a href="#网络训练去噪器" class="headerlink" title="网络训练去噪器"></a>网络训练去噪器</h6><h6 id="估计出当前噪音，得到Xt-1"><a href="#估计出当前噪音，得到Xt-1" class="headerlink" title="估计出当前噪音，得到Xt-1"></a>估计出当前噪音，得到Xt-1</h6><p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-14-40-23-image.png"></p>
<h6 id="总的来说"><a href="#总的来说" class="headerlink" title="总的来说"></a>总的来说</h6><p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-14-40-53-image.png"></p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><h6 id="训练过程"><a href="#训练过程" class="headerlink" title="训练过程"></a>训练过程</h6><p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-15-02-26-image.png"></p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-15-02-36-image.png"></p>
<h6 id="推理过程"><a href="#推理过程" class="headerlink" title="推理过程"></a>推理过程</h6><p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-15-05-08-image.png"></p>
<h3 id="DDIM"><a href="#DDIM" class="headerlink" title="DDIM"></a>DDIM</h3><p><em>DENOISING</em> <em>DIFFUSION</em> <em>IMPLICIT</em> <em>MODELS</em></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ermongroup/ddim">https://github.com/ermongroup/ddim</a></p>
<h4 id="论文原理"><a href="#论文原理" class="headerlink" title="论文原理"></a>论文原理</h4><p>DDPM在采样的时候，需要利用到xt-1 扩散到xt的知识，导致sample速度过慢，而DDIM可以只利用predicted X0 Xt，去求Xt-1，这样就不要求一步步采样了。</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-17-02-20-image.png"></p>
<h6 id="reverse过程"><a href="#reverse过程" class="headerlink" title="reverse过程"></a>reverse过程</h6><p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-17-10-28-image.png"></p>
<h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h4><h6 id="训练过程，和DDPM一样"><a href="#训练过程，和DDPM一样" class="headerlink" title="训练过程，和DDPM一样"></a>训练过程，和DDPM一样</h6><p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-15-41-04-image.png"></p>
<h6 id="推理过程-1"><a href="#推理过程-1" class="headerlink" title="推理过程"></a>推理过程</h6><p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-19-17-13-30-image.png"></p>
<h3 id="SDE"><a href="#SDE" class="headerlink" title="SDE"></a>SDE</h3><h4 id="论文原理-1"><a href="#论文原理-1" class="headerlink" title="论文原理"></a>论文原理</h4><h5 id="SDE时间上连续-，正向和逆向推导过程"><a href="#SDE时间上连续-，正向和逆向推导过程" class="headerlink" title="SDE时间上连续 ，正向和逆向推导过程"></a>SDE时间上连续 ，正向和逆向推导过程</h5><p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-30-16-57-36-image.png"></p>
<h5 id="涵盖了之前的score-base-和ddpm"><a href="#涵盖了之前的score-base-和ddpm" class="headerlink" title="涵盖了之前的score base 和ddpm"></a>涵盖了之前的score base 和ddpm</h5><p><strong>score base VE</strong></p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-30-17-45-20-image.png"></p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-30-17-45-29-image.png"></p>
<p><strong>ddpm VP</strong></p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-30-17-45-41-image.png"></p>
<p>结合上述两种扩散方式 提出<strong>sub-VP SDE</strong> 目的是<em>which perform particularly well on</em></p>
<p><em>likelihoods</em></p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-30-17-46-19-image.png"></p>
<h5 id="PC采样："><a href="#PC采样：" class="headerlink" title="PC采样："></a>PC采样：</h5><p>用SDE数值求解预测出结果，再用分数估计修正结果。这部分也有一些实验性结论，比如correct一步还是n步。结合了两种采样方式 *unifies and improves over existing sampling methods for score-based models.</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-31-09-46-38-image.png"></p>
<h5 id="PC的原因"><a href="#PC的原因" class="headerlink" title="PC的原因"></a>PC的原因</h5><p>纠正离散步长不准确？</p>
<h5 id="ODE"><a href="#ODE" class="headerlink" title="ODE"></a>ODE</h5><p>就是一种和SDE有同样边缘概率分布的采样方式  likelihood <em>fast adaptive sampling via black-box ODE solvers, flexible data manipulation via latent codes, a uniquely identifiable encoding, and notably, exact likelihood computation.</em></p>
<h5 id="controllable-generation"><a href="#controllable-generation" class="headerlink" title="controllable generation"></a>controllable generation</h5><p>对于score模型 只要知道了 每个时刻condition 的score 就可以根据condition生成图片了，总之就是额外或者利用domain信息，得到一个跟condition有关的score，放到采样过程中就行。主要应用有，分类图片生成，图片补全，图片上色。</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-31-10-57-01-image.png"></p>
<p>这里这些condition都是sample时候加进去的，不涉及估计score的那个训练阶段。</p>
<h4 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h4><h5 id="怎么训练分数网络"><a href="#怎么训练分数网络" class="headerlink" title="怎么训练分数网络"></a>怎么训练分数网络</h5><p>score 本质上还是和noise z相关的的一个估计</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-27-11-22-43-image.png"></p>
<h5 id="怎么采样"><a href="#怎么采样" class="headerlink" title="怎么采样"></a>怎么采样</h5><p>PC采样的框架</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-10-26-19-05-37-image.png"></p>
<p>不同数值求解器的predictor</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-11-01-10-00-40-image.png"></p>
<p>不同数值求解器的correcter,只截取了部分 还有很多</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/DDPM/2023-11-01-10-04-05-image.png"></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Dd4y1A7oz/?spm_id_from=333.999.0.0&amp;vd_source=857061537338948659f6d0f1f3868d83">https://www.bilibili.com/video/BV1Dd4y1A7oz/?spm_id_from=333.999.0.0&amp;vd_source=857061537338948659f6d0f1f3868d83</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19M411z7hS/?spm_id_from=333.999.0.0&amp;vd_source=857061537338948659f6d0f1f3868d83">https://www.bilibili.com/video/BV19M411z7hS/?spm_id_from=333.999.0.0&amp;vd_source=857061537338948659f6d0f1f3868d83</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1jg411Q7bQ/?spm_id_from=333.337.search-card.all.click&amp;vd_source=857061537338948659f6d0f1f3868d83">https://www.bilibili.com/video/BV1jg411Q7bQ/?spm_id_from=333.337.search-card.all.click&amp;vd_source=857061537338948659f6d0f1f3868d83</a></p>
<h3 id="CompVis"><a href="#CompVis" class="headerlink" title="CompVis"></a>CompVis</h3><h4 id="论文思想"><a href="#论文思想" class="headerlink" title="论文思想"></a>论文思想</h4><p><em>High-Resolution Image Synthesis with Latent Diffusion Models</em></p>
<p>利用预先训练好的encoder decoder，将图像映射到latent space上再做DM，这样节省计算资源，因此可以训练高清图片。</p>
<p>在去噪器的结构里加入<em>cross-attention layers</em> 实现更丰富的控制生成。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/CompVis/latent-diffusion">https://github.com/CompVis/latent-diffusion</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/10/19/DDPM-DDIM-SDE-CompVis/" data-id="clofdh9ep0000n8fb7d6b0tdk" data-title="DDPM_DDIM_SDE_CompVis" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AIGC/" rel="tag">AIGC</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-c的优化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/25/c%E7%9A%84%E4%BC%98%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2023-09-25T02:41:48.000Z" itemprop="datePublished">2023-09-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/09/25/c%E7%9A%84%E4%BC%98%E5%8C%96/">c的优化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="step1-对c-代码的优化"><a href="#step1-对c-代码的优化" class="headerlink" title="step1 对c++ 代码的优化"></a>step1 对c++ 代码的优化</h3><ol>
<li><p>从算法逻辑上优化，整体调用逻辑，何时准备什么类型的数据。还有算法层面：比如滑动窗口和等。</p>
</li>
<li><p>对数据精度进行优化，例如double能变成float 的，float能拉伸成整数的。必要时标明数据的实际范围（0～10bit）这种。</p>
</li>
<li><p>对除法能被乘法代替的，乘法能用加法替代的，乘法能用位移替代的运算进行优化。</p>
</li>
<li><p>对kn ，（k+1）n这类的运算也可以优化。</p>
</li>
<li><p>减少if else分支语句内的内容，能合并的合并</p>
</li>
</ol>
<h3 id="step2-c写汇编"><a href="#step2-c写汇编" class="headerlink" title="step2 c写汇编"></a>step2 c写汇编</h3><ol>
<li><p>首先原则是 利用函数指针，当运行c的时候就指向c，当运行汇编时就指向汇编</p>
</li>
<li><p>汇编加速的原理是利用单指令多数据的方式进行加速</p>
</li>
<li><p>确定输入输出的尺寸，是固定还是任意，是否是偶数，8对齐 16对齐等</p>
</li>
<li><p>先把c转化成利用flag标识if else的语句。</p>
</li>
<li><p>确定每一个变量在其生命周期中，数据范围，可并行范围，能并行运算并行，不能时再拆开</p>
</li>
<li><p>根据运算的并行度，将常数都定义好 是u8 u16 还是u32 还是有符号的s。</p>
</li>
<li><p>如果大部分操作都可以在int16x8上操作 那就一次读8个 如果大部分操作都能在uint8上操作 那就一次读16个 ，以此类推。</p>
</li>
</ol>
<h3 id="step3-汇编注意事项"><a href="#step3-汇编注意事项" class="headerlink" title="step3 汇编注意事项"></a>step3 汇编注意事项</h3><ol>
<li><p>有些运算涉及负数，需要用有符号运算s</p>
</li>
<li><p>有些数据必须用uint 才能装下</p>
</li>
<li><p>作为if 条件标识的flag 再需要扩占位数时，需要用s有符号，才能补全高位</p>
</li>
</ol>
<h3 id="ARM-Neon-Intrinsics-指令相关文档："><a href="#ARM-Neon-Intrinsics-指令相关文档：" class="headerlink" title="ARM Neon Intrinsics 指令相关文档："></a>ARM Neon Intrinsics 指令相关文档：</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012385733/article/details/121086734">https://blog.csdn.net/u012385733/article/details/121086734</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.arm.com/architectures/instruction-sets/intrinsics/https://developer.arm.com/architectures/instruction-sets/intrinsics/">https://developer.arm.com/architectures/instruction-sets/intrinsics/https://developer.arm.com/architectures/instruction-sets/intrinsics/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/25/c%E7%9A%84%E4%BC%98%E5%8C%96/" data-id="clmym1yv90000vxfbe9un8bxy" data-title="c的优化" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-函数与汇编" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/08/04/%E5%87%BD%E6%95%B0%E4%B8%8E%E6%B1%87%E7%BC%96/" class="article-date">
  <time class="dt-published" datetime="2023-08-04T06:22:38.000Z" itemprop="datePublished">2023-08-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/08/04/%E5%87%BD%E6%95%B0%E4%B8%8E%E6%B1%87%E7%BC%96/">函数与汇编</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="X86-X64-arm64"><a href="#X86-X64-arm64" class="headerlink" title="X86 X64 arm64"></a>X86 X64 arm64</h4><p>arm64 精简指令集</p>
<p>X86 复杂指令集 32位</p>
<p>X64 复杂指令集 64位</p>
<h4 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h4><p>向下兼容</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/opt/2023-08-04-14-28-14-image.png"></p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/opt/2023-08-04-14-28-37-image.png"></p>
<h4 id="应用程序地址空间"><a href="#应用程序地址空间" class="headerlink" title="应用程序地址空间"></a>应用程序地址空间</h4><p>操作系统通过虚拟内存的方式为所有应用程序提供了统一的内存映射地址。如图3所示，从上到下分别是用户栈、共享库内存、运行时堆和代码段。当然这个是一个大概的分段，实际分段比这个可能稍微复杂一些，但整个格局没有大变化。</p>
<img title="" src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/opt/2023-08-04-14-29-49-image.png" alt="" data-align="center">

<h4 id="函数调用及汇编指令"><a href="#函数调用及汇编指令" class="headerlink" title="函数调用及汇编指令"></a>函数调用及汇编指令</h4><p>函数调用主要是call和ret。汇编语言的call指令相当于执行了2步操作，分别是，1）将当前的IP或CS和IP压入栈中； 2）跳转，类似与jmp指令。同样，ret指令也分2步，分别是，1）将栈中的地址弹出到IP寄存器；2）跳转执行后续指令。这个基本上就是函数调用的原理。</p>
<p>除了在代码间的跳动外，函数的调用往往还需要传递一个参数，而处理完成后还可能有返回值。这些数据的传递都是通过寄存器进行的。在函数调用之前通过上文介绍的寄存器存储参数，函数返回之前通过RAX寄存器（32位系统为EAX）存储返回结果。</p>
<p>函数的参数是从右往左传递的。</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/opt/2023-08-04-14-37-09-image.png"></p>
<p><strong>另外一个比较重要的知识点是函数调用过程中与堆栈相关的寄存器RSP和RBP</strong>，</p>
<p>RSP（32位叫ESP）：栈指针寄存器<a href="https://link.zhihu.com/?target=https://jq.qq.com/?_wv=1027&k=5MlTvNe">(reextended stack pointer)，其内存放着一个指针，该指针永远指向系统栈最上面一个栈帧的栈</a>顶。</p>
<p>RBP（32位叫EBP）：基址指针寄存器(reextended base pointer)，其内存放着一个指针，该指针永远指向系统栈最上面一个栈帧的底部。</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/opt/2023-08-04-14-47-11-image.png"><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/opt/2023-08-04-14-58-40-image.png"></p>
<p>可以看出函数内，局部变量的地址是越来越低的。rsp栈顶</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/opt/2023-08-04-14-55-57-image.png"></p>
<p>到运行到call Blur时，先将main函数的栈底（高地址）push rbp。</p>
<p>并且将main函数的栈顶rsp作为新调用函数blur的栈底 mov rbp  &lt;- rsp。</p>
<p>然后把传进来的参数放在新的栈顶（rbp - 112） mov DWORD PTR [rbp-112], r9d</p>
<p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/opt/2023-08-04-16-38-11-image.png"></p>
<p>把函数内的局部变量放在栈底并且向上生长（rbp-8）int* pA1 &#x3D; pSrc - strideS*2; mov QWORD PTR [rbp-8], rax</p>
<h4 id="函数语句以及汇编指令"><a href="#函数语句以及汇编指令" class="headerlink" title="函数语句以及汇编指令"></a>函数语句以及汇编指令</h4><h5 id="基本指令"><a href="#基本指令" class="headerlink" title="基本指令"></a>基本指令</h5><table>
<thead>
<tr>
<th>指令</th>
<th>指令</th>
<th>耗时latency</th>
<th>Rthroughput</th>
</tr>
</thead>
<tbody><tr>
<td>sub eax, 5</td>
<td>寄存器 - 常数</td>
<td>1</td>
<td>0.25</td>
</tr>
<tr>
<td>mov eax, dword ptr [rax]</td>
<td>读 32位</td>
<td>5</td>
<td>0.5</td>
</tr>
<tr>
<td>mov rax, qword ptr [rbp - 8]</td>
<td>读64位</td>
<td>5</td>
<td>0.5</td>
</tr>
<tr>
<td>mov qword ptr [rbp - 24], rax</td>
<td>写64位</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>jmp .L3</td>
<td></td>
<td>1</td>
<td>0.5</td>
</tr>
<tr>
<td>add     rax, rdx</td>
<td>寄存器相加</td>
<td>1</td>
<td>0.25</td>
</tr>
<tr>
<td>neg rax</td>
<td>取反</td>
<td>1</td>
<td>0.25</td>
</tr>
<tr>
<td>shl rax, 2</td>
<td>左移</td>
<td>1</td>
<td>0.5</td>
</tr>
<tr>
<td>cdqe</td>
<td>它用于将一个32位有符号整数（存储在 EAX 寄存器中）扩展为一个64位有符号整数（扩展到 RAX 寄存器中）</td>
<td>1</td>
<td>0.25</td>
</tr>
<tr>
<td>lea   rdx, [4*rax]</td>
<td>“Load Effective Address”  lea destination, source</td>
<td>1</td>
<td>0.5</td>
</tr>
</tbody></table>
<h5 id="C-语句对应指令"><a href="#C-语句对应指令" class="headerlink" title="C++ 语句对应指令"></a>C++ 语句对应指令</h5><style>
</style>

<table>
<thead>
<tr>
<th align="center"></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>int f &#x3D; pA1[w];</strong></td>
<td>mov eax, DWORD PTR [rbp-48]</td>
<td>读w的地址</td>
<td>5</td>
</tr>
<tr>
<td align="center"></td>
<td>cdqe</td>
<td>32eax 64位rax</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>lea rdx, [0+rax*4]</td>
<td>读w地址对应的数据w</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>mov rax, QWORD PTR [rbp-8]</td>
<td>读pA1的地址</td>
<td>5</td>
</tr>
<tr>
<td align="center"></td>
<td>add rax, rdx</td>
<td>地址偏移w</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>mov eax, DWORD PTR [rax]</td>
<td>读pA1[w] 地址对应的数据</td>
<td>5</td>
</tr>
<tr>
<td align="center"></td>
<td>mov DWORD PTR [rbp-68], eax</td>
<td>写到f里</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td align="center"><strong>int c &#x3D;pA1[w] + pA1[w - 1];</strong></td>
<td>mov eax, DWORD PTR [rbp-48]</td>
<td>读w的地址</td>
<td>5</td>
</tr>
<tr>
<td align="center"></td>
<td>cdqe</td>
<td>32eax 64位rax</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>lea rdx, [0+rax*4]</td>
<td>读w地址对应的数据w</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>mov rax, QWORD PTR [rbp-8]</td>
<td>读pA1的地址</td>
<td>5</td>
</tr>
<tr>
<td align="center"></td>
<td>add rax, rdx</td>
<td>地址偏移w</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>mov edx, DWORD PTR [rax]</td>
<td>读pA1[w] 地址对应的数据</td>
<td>5</td>
</tr>
<tr>
<td align="center"></td>
<td>mov eax, DWORD PTR [rbp-48]</td>
<td>读w的地址</td>
<td>5</td>
</tr>
<tr>
<td align="center"></td>
<td>cdqe</td>
<td>32eax 64位rax</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>add rax, 1</td>
<td>地址w+1</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>lea rcx, [0+rax*4]</td>
<td>读w+1地址对应的数据</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>mov rax, QWORD PTR [rbp-8]</td>
<td>读pA1的地址</td>
<td>5</td>
</tr>
<tr>
<td align="center"></td>
<td>add rax, rcx</td>
<td>地址偏移w</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>mov eax, DWORD PTR [rax]</td>
<td>读pA1[w] 地址对应的数据</td>
<td>5</td>
</tr>
<tr>
<td align="center"></td>
<td>add eax, edx</td>
<td>add两个数字</td>
<td>1</td>
</tr>
<tr>
<td align="center"></td>
<td>mov DWORD PTR [rbp-56], eax</td>
<td>写</td>
<td>1</td>
</tr>
</tbody></table>
<style>
</style>

<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>sum &#x3D;<br> (sum * 327)&gt;&gt;13;</strong></td>
<td>mov eax, DWORD PTR [rbp-92]</td>
</tr>
<tr>
<td></td>
<td>imul eax, eax, 327</td>
</tr>
<tr>
<td></td>
<td>sar eax, 13</td>
</tr>
<tr>
<td></td>
<td>mov DWORD PTR [rbp-92], eax</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>sum &#x3D; sum &#x2F; 25;</strong></td>
<td>mov eax, DWORD PTR [rbp-92]</td>
</tr>
<tr>
<td>（在sum最大范围数据类型最大精度下优化算法）</td>
<td>movsx rdx, eax</td>
</tr>
<tr>
<td></td>
<td>imul rdx, rdx, 1374389535</td>
</tr>
<tr>
<td></td>
<td>shr rdx, 32</td>
</tr>
<tr>
<td></td>
<td>mov ecx, edx</td>
</tr>
<tr>
<td></td>
<td>sar ecx, 3</td>
</tr>
<tr>
<td></td>
<td>cdq</td>
</tr>
<tr>
<td></td>
<td>mov eax, ecx</td>
</tr>
<tr>
<td></td>
<td>sub eax, edx</td>
</tr>
<tr>
<td></td>
<td>mov DWORD PTR [rbp-92], eax</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>pBlur[w] &#x3D; static_cast<int>(sum);</strong></td>
<td>mov eax, DWORD PTR [rbp-48]</td>
</tr>
<tr>
<td></td>
<td>cdqe</td>
</tr>
<tr>
<td></td>
<td>lea rdx, [0+rax*4]</td>
</tr>
<tr>
<td></td>
<td>mov rax, QWORD PTR [rbp-104]</td>
</tr>
<tr>
<td></td>
<td>add rdx, rax</td>
</tr>
<tr>
<td></td>
<td>mov eax, DWORD PTR [rbp-92]</td>
</tr>
<tr>
<td></td>
<td>mov DWORD PTR [rdx], eax</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>for (int h &#x3D; 0; h &lt; height; h++)</strong></td>
<td>mov DWORD PTR [rbp-44], 0</td>
</tr>
<tr>
<td></td>
<td>jmp .L2</td>
</tr>
<tr>
<td></td>
<td>L2:</td>
</tr>
<tr>
<td></td>
<td>mov eax, DWORD PTR [rbp-44]</td>
</tr>
<tr>
<td></td>
<td>cmp eax, DWORD PTR [rbp-128]</td>
</tr>
<tr>
<td></td>
<td>jl .L5</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://godbolt.org/">https://godbolt.org/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/08/04/%E5%87%BD%E6%95%B0%E4%B8%8E%E6%B1%87%E7%BC%96/" data-id="clkwd4jyl0000w1fb28io9oaq" data-title="函数与汇编" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B1%87%E7%BC%96/" rel="tag">汇编</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-积分图和滑动窗口" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/08/03/%E7%A7%AF%E5%88%86%E5%9B%BE%E5%92%8C%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/" class="article-date">
  <time class="dt-published" datetime="2023-08-03T09:49:00.000Z" itemprop="datePublished">2023-08-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/08/03/%E7%A7%AF%E5%88%86%E5%9B%BE%E5%92%8C%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/">积分图和滑动窗口</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="d-d-模糊-filter"><a href="#d-d-模糊-filter" class="headerlink" title="d*d 模糊 filter"></a>d*d 模糊 filter</h3><p>对原图做r*r 的均值模糊 以循环方式书写运算次数为  (d * d) * (HW)，优化目标：运算次数和半径无关</p>
<h3 id="积分图"><a href="#积分图" class="headerlink" title="积分图"></a>积分图</h3><h6 id="step-0-该padding还都得padding，d-x3D-2r-1。那原图需要padding-成-（h-2r）-（w-2r"><a href="#step-0-该padding还都得padding，d-x3D-2r-1。那原图需要padding-成-（h-2r）-（w-2r" class="headerlink" title="step 0 该padding还都得padding，d &#x3D; 2r + 1。那原图需要padding 成 （h+2r）* （w+2r)"></a>step 0 该padding还都得padding，d &#x3D; 2r + 1。那原图需要padding 成 （h+2r）* （w+2r)</h6><h6 id="step1-计算积分图-积分图在padding-的结果上还需要再加一行一列-（h-2r-1）-（w-2r-1-，因为积分图每一点xy表示的是x之前-y之前那个矩形的和。如下图-绿色面积表示padding后的图像，蓝色为积分图增加的内存，xy点的值就是蓝绿色面积内的和"><a href="#step1-计算积分图-积分图在padding-的结果上还需要再加一行一列-（h-2r-1）-（w-2r-1-，因为积分图每一点xy表示的是x之前-y之前那个矩形的和。如下图-绿色面积表示padding后的图像，蓝色为积分图增加的内存，xy点的值就是蓝绿色面积内的和" class="headerlink" title="step1 计算积分图 积分图在padding 的结果上还需要再加一行一列 （h+2r+1）* （w+2r+1)，因为积分图每一点xy表示的是x之前 y之前那个矩形的和。如下图 绿色面积表示padding后的图像，蓝色为积分图增加的内存，xy点的值就是蓝绿色面积内的和"></a>step1 计算积分图 积分图在padding 的结果上还需要再加一行一列 （h+2r+1）* （w+2r+1)，因为积分图每一点xy表示的是x之前 y之前那个矩形的和。如下图 绿色面积表示padding后的图像，蓝色为积分图增加的内存，xy点的值就是蓝绿色面积内的和</h6><img title="" src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/winsum/2023-08-04-10-30-38-image.png" alt="" data-align="center">

<h6 id="step2-filter-对一个点-m-n-进行3-3的boxfilter为例，需要在积分图上进行-1-4-2-3操作"><a href="#step2-filter-对一个点-m-n-进行3-3的boxfilter为例，需要在积分图上进行-1-4-2-3操作" class="headerlink" title="step2 filter 对一个点(m,n) 进行3*3的boxfilter为例，需要在积分图上进行 1 + 4 - 2 - 3操作"></a>step2 filter 对一个点(m,n) 进行3*3的boxfilter为例，需要在积分图上进行 1 + 4 - 2 - 3操作</h6><img title="" src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/winsum/2023-08-04-10-42-53-image.png" alt="" data-align="center">

<h3 id="滑动窗口"><a href="#滑动窗口" class="headerlink" title="滑动窗口"></a>滑动窗口</h3><h6 id="step-0-该padding还都得padding，d-x3D-2r-1。那原图需要padding-成-（h-2r）-（w-2r-1"><a href="#step-0-该padding还都得padding，d-x3D-2r-1。那原图需要padding-成-（h-2r）-（w-2r-1" class="headerlink" title="step 0 该padding还都得padding，d &#x3D; 2r + 1。那原图需要padding 成 （h+2r）* （w+2r)"></a>step 0 该padding还都得padding，d &#x3D; 2r + 1。那原图需要padding 成 （h+2r）* （w+2r)</h6><h6 id="step1-计算d行和，申请1-w-2r-大小的空间，存储当前位置d行和。"><a href="#step1-计算d行和，申请1-w-2r-大小的空间，存储当前位置d行和。" class="headerlink" title="step1 计算d行和，申请1*w+2r 大小的空间，存储当前位置d行和。"></a>step1 计算d行和，申请1*w+2r 大小的空间，存储当前位置d行和。</h6><p><img src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/winsum/2023-08-04-10-51-37-image.png"></p>
<h6 id="step2-由行和先计算第一个窗口和，代表00点的窗口和-随后每次减去最左边的d行和-加上最右边的d行和"><a href="#step2-由行和先计算第一个窗口和，代表00点的窗口和-随后每次减去最左边的d行和-加上最右边的d行和" class="headerlink" title="step2 由行和先计算第一个窗口和，代表00点的窗口和, 随后每次减去最左边的d行和 加上最右边的d行和"></a>step2 由行和先计算第一个窗口和，代表00点的窗口和, 随后每次减去最左边的d行和 加上最右边的d行和</h6><img title="" src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/winsum/2023-08-04-11-05-20-image.png" alt="" data-align="center">

<h6 id="step3-继续向下滑动，先通过减第一行加下面一行的原图更新d行和，再重复计算窗口和步骤"><a href="#step3-继续向下滑动，先通过减第一行加下面一行的原图更新d行和，再重复计算窗口和步骤" class="headerlink" title="step3 继续向下滑动，先通过减第一行加下面一行的原图更新d行和，再重复计算窗口和步骤"></a>step3 继续向下滑动，先通过减第一行加下面一行的原图更新d行和，再重复计算窗口和步骤<img title="" src="https://github.com/Aacrobat/Aacrobat.github.io/raw/master/img/winsum/2023-08-04-11-06-37-image.png" alt="" data-align="center"></h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/08/03/%E7%A7%AF%E5%88%86%E5%9B%BE%E5%92%8C%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/" data-id="clkw0hme200005afbglhs4x56" data-title="积分图和滑动窗口" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BC%98%E5%8C%96/" rel="tag">优化</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AIGC/" rel="tag">AIGC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CMake/" rel="tag">CMake</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hydra/" rel="tag">Hydra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdow/" rel="tag">Markdow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Retinex/" rel="tag">Retinex</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algo/" rel="tag">algo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/codec/" rel="tag">codec</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ffmpeg/" rel="tag">ffmpeg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mac/" rel="tag">mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software-install/" rel="tag">software_install</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BC%98%E5%8C%96/" rel="tag">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B1%87%E7%BC%96/" rel="tag">汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AIGC/" style="font-size: 12.5px;">AIGC</a> <a href="/tags/CMake/" style="font-size: 10px;">CMake</a> <a href="/tags/Hydra/" style="font-size: 10px;">Hydra</a> <a href="/tags/Markdow/" style="font-size: 10px;">Markdow</a> <a href="/tags/Retinex/" style="font-size: 10px;">Retinex</a> <a href="/tags/algo/" style="font-size: 12.5px;">algo</a> <a href="/tags/c/" style="font-size: 17.5px;">c++</a> <a href="/tags/codec/" style="font-size: 10px;">codec</a> <a href="/tags/ffmpeg/" style="font-size: 10px;">ffmpeg</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/software-install/" style="font-size: 10px;">software_install</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 10px;">优化</a> <a href="/tags/%E6%B1%87%E7%BC%96/" style="font-size: 15px;">汇编</a> <a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">测试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/11/24/CMake-%E7%AE%80%E5%8D%95%E7%94%A8%E6%B3%95/">CMake 简单用法</a>
          </li>
        
          <li>
            <a href="/2023/11/22/%E5%B8%B8%E8%A7%81%E6%93%8D%E4%BD%9C%E7%9A%84%E8%80%97%E6%97%B6/">常见操作的耗时</a>
          </li>
        
          <li>
            <a href="/2023/11/21/arm-intrinsic-%E6%8C%87%E4%BB%A4%E6%9F%A5%E8%AF%A2%E6%8A%80%E5%B7%A7/">arm intrinsic 指令查询技巧</a>
          </li>
        
          <li>
            <a href="/2023/11/14/banding-artifact/">banding artifact</a>
          </li>
        
          <li>
            <a href="/2023/11/01/ControlNet/">ControlNet</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>